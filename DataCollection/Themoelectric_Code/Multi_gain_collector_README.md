# Multi_gain_collector.py 使用说明

## 概述

`Multi_gain_collector.py` 是一个增强版的热电芯片数据采集脚本，基于 `Full_collector.py` 开发。主要改进是支持多增益采集，解决了原脚本中固定增益可能导致的量程限制问题。

## 主要特性

1. **多增益采集**: 对每个通道在5个增益设置下进行采集
   - Gain 16: ±0.256V（最高精度）
   - Gain 8:  ±0.512V
   - Gain 4:  ±1.024V
   - Gain 2:  ±2.048V
   - Gain 1:  ±4.096V（最大量程）

2. **自动最优值选择**: 自动选择既在有效量程内（≤95%满量程）又具有最高精度的测量值

3. **完整数据记录**: CSV文件中记录所有增益下的测量值以及最优值

## 与 Full_collector.py 的区别

| 特性 | Full_collector.py | Multi_gain_collector.py |
|------|-------------------|-------------------------|
| 增益设置 | 固定 Gain=16 | 5个增益: 16, 8, 4, 2, 1 |
| 电压范围 | 仅 ±0.256V | ±0.256V 到 ±4.096V |
| CSV列数 | 10列 | 58列 |
| 采集时间 | ~10秒/次 | ~10秒/次（自动调整） |
| 数据量 | 较小 | 较大（包含所有增益数据） |

## CSV 文件格式

### 列结构（每个TEC有7列）

对于每个TEC（TEC1-TEC8），CSV包含以下列：
- `TEC{N}_Gain16(V)`: 增益16下的电压
- `TEC{N}_Gain8(V)`: 增益8下的电压
- `TEC{N}_Gain4(V)`: 增益4下的电压
- `TEC{N}_Gain2(V)`: 增益2下的电压
- `TEC{N}_Gain1(V)`: 增益1下的电压
- `TEC{N}_Optimal(V)`: 最优电压值
- `TEC{N}_OptimalGain`: 最优值对应的增益

### 示例

```csv
Timestamp,DateTime,TEC1_Gain16(V),TEC1_Gain8(V),TEC1_Gain4(V),TEC1_Gain2(V),TEC1_Gain1(V),TEC1_Optimal(V),TEC1_OptimalGain,...
1732183505.123,2024-11-21 09:25:05,0.150000000,0.150000000,0.150000000,0.150000000,0.150000000,0.150000000,16,...
```

## 使用方法

### 1. 安装依赖

```bash
cd DataCollection
pip3 install -r requirements.txt
```

### 2. 运行脚本

```bash
cd DataCollection/Themoelectric_Code
python3 Multi_gain_collector.py
```

### 3. 停止采集

按 `Ctrl+C` 停止数据采集。

## 配置参数

在脚本开头可以修改以下参数：

```python
SAMPLE_INTERVAL = 10  # 采集间隔（秒）
GAINS_TO_TEST = [16, 8, 4, 2, 1]  # 需要测试的增益列表
```

## 最优值选择算法

脚本使用以下规则选择最优电压值：

1. 遍历所有增益设置（从高精度到低精度）
2. 检查该增益下的电压是否在有效范围内：`|电压| ≤ 满量程 × 0.95`
3. 选择第一个满足条件的值（即精度最高的有效值）
4. 如果所有增益都无效，则最优值为 None

### 示例

假设测量到的实际电压为 0.300V：
- Gain 16 (±0.256V): 0.300V > 0.2432V (95%阈值) ❌
- Gain 8 (±0.512V): 0.300V ≤ 0.4864V ✓ **选中**

## 数据分析建议

使用 CSV 数据时的建议：

1. **优先使用最优值列**: `TEC{N}_Optimal(V)` 已经过算法筛选
2. **检查增益列**: `TEC{N}_OptimalGain` 可以了解数据的有效范围
3. **分析所有增益数据**: 可以用于验证测量一致性
4. **空值处理**: 空值表示该增益下读取失败

## 故障排除

### 问题: 所有增益下都读取失败
- 检查I2C连接
- 检查ADS1115电源
- 检查传感器连接

### 问题: 最优值经常为空
- 可能传感器输出超出所有量程
- 检查传感器工作状态
- 考虑增加更低的增益设置

### 问题: 采集速度较慢
- 这是正常的，因为需要多次改变增益并读取
- 可以减少 `GAINS_TO_TEST` 中的增益数量
- 可以调整每个增益切换后的延迟时间

## 技术细节

### 增益切换延迟

脚本在每次改变增益后等待 10ms (`time.sleep(0.01)`)，以确保ADC设置生效。这是必要的，因为ADS1115需要时间来调整其内部放大器。

### 数据精度

所有电压值保存为9位小数（纳伏级精度），确保不丢失ADC的原始精度。

### 内存使用

由于需要存储更多数据，CSV文件会比 Full_collector.py 生成的文件大约5-7倍。

## 许可和贡献

本脚本基于 Full_collector.py 开发，保持相同的代码风格和结构。

如有问题或建议，请联系项目维护者。
